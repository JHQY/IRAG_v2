<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>基于大语言模型的保险知识库问答系统 / Question Answering System Based on LLM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        height: 100%;
      }
      :root {
        --bg-color: #0f172a;
        --text-color: #e5e7eb;
        --card-bg: #020617;
        --card-border: #1f2937;
        --card-shadow: 0 10px 30px rgba(15, 23, 42, 0.6);
        --input-bg: #020617;
        --input-border: #374151;
        --muted-color: #9ca3af;
        --muted-strong-color: #6b7280;
        --danger-color: #fca5a5;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
      }
      body.theme-dark {
        --bg-color: #0f172a;
        --text-color: #e5e7eb;
        --card-bg: #020617;
        --card-border: #1f2937;
        --card-shadow: 0 10px 30px rgba(15, 23, 42, 0.6);
        --input-bg: #020617;
        --input-border: #374151;
        --muted-color: #9ca3af;
        --muted-strong-color: #6b7280;
        --danger-color: #fca5a5;
      }
      body.theme-light {
        --bg-color: #f9fafb;
        --text-color: #111827;
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --card-shadow: 0 12px 30px rgba(148, 163, 184, 0.35);
        --input-bg: #ffffff;
        --input-border: #d1d5db;
        --muted-color: #6b7280;
        --muted-strong-color: #4b5563;
        --danger-color: #b91c1c;
      }
      .app-container {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .header {
        text-align: center;
        margin-bottom: 24px;
      }
      h1 {
        font-size: 24px;
        margin: 0;
      }
      .header-controls {
        margin-top: 12px;
        display: flex;
        justify-content: center;
        flex-wrap: nowrap;
        gap: 16px;
      }
      .inline-label {
        font-size: 12px;
        color: var(--muted-color);
        margin-right: 4px;
      }
      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px 18px 18px;
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
      }
      .chat-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 360px;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
      }
      .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 8px 4px 4px;
        margin-bottom: 0;
      }
      .turn-block {
        padding: 10px 8px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      }
      .turn-block:last-child {
        border-bottom: none;
      }
      .msg-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }
      .msg-row.user,
      .msg-row.assistant {
        justify-content: flex-start;
      }
      .msg-icon {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 15px;
        font-weight: 600;
        color: #ffffff;
      }
      .msg-icon.user {
        background: #f97316;
      }
      .msg-icon.assistant {
        background: #3b82f6;
      }
      .msg-bubble {
        flex: 1;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #111827;
      }
      body.theme-dark .msg-bubble.user {
        background: #111827;
        border-color: #374151;
        color: #e5e7eb;
      }
      body.theme-dark .msg-bubble.assistant {
        background: #020617;
        border-color: #4b5563;
        color: #e5e7eb;
      }
      .kb-section {
        margin-top: 6px;
        padding-left: 2px;
      }
      .kb-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 4px;
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: #374151;
        font-size: 13px;
        cursor: pointer;
        width: 100%;
      }
      .chevron {
        transition: transform 0.12s ease-out;
        font-size: 14px;
        font-weight: 600;
      }
      .chevron.open {
        transform: rotate(180deg);
      }
      .kb-panel {
        margin-top: 6px;
      }
      .empty-hint {
        padding: 24px 8px 10px;
        text-align: center;
        font-size: 13px;
        color: var(--muted-color);
      }
      label {
        font-size: 13px;
        color: var(--muted-color);
        display: block;
        margin-bottom: 6px;
      }
      textarea {
        width: 100%;
        min-height: 80px;
        max-height: 200px;
        resize: vertical;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 14px;
      }
      textarea:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow: 0 0 0 1px #0ea5e9;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-top: 12px;
      }
      select, input[type="number"] {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 13px;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        color: #0f172a;
        background: linear-gradient(135deg, #38bdf8, #a855f7);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 25px rgba(56, 189, 248, 0.35);
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, opacity 0.12s ease-out;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(56, 189, 248, 0.45);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 8px 18px rgba(56, 189, 248, 0.35);
      }
      .answer-card {
        margin-top: 18px;
        padding: 14px 16px 16px;
        border-radius: 10px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
      }
      .answer-title {
        font-size: 13px;
        color: #9ca3af;
        margin-bottom: 6px;
      }
      .answer-text {
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
      }
      .refs {
        margin-top: 14px;
      }
      .ref-item {
        padding: 8px 10px 10px;
        border-radius: 8px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted-color);
      }
      .ref-meta {
        font-size: 11px;
        color: var(--muted-strong-color);
        margin-top: 4px;
      }
      body.theme-dark .kb-toggle {
        border-color: #374151;
        background: #020617;
        color: #e5e7eb;
      }
      body.theme-dark .ref-item {
        background: #020617;
        border-color: #111827;
        color: #9ca3af;
      }
      body.theme-dark .ref-meta {
        color: #6b7280;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted-color);
      }
      .status.error {
        color: var(--danger-color);
      }
      .ghost-button {
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 12px;
        border: 1px solid var(--card-border);
        background: transparent;
        color: var(--muted-color);
        box-shadow: none;
      }
      .ghost-button:hover:not(:disabled) {
        background: rgba(148, 163, 184, 0.1);
      }
      .input-card {
        margin-top: 0;
        background: var(--card-bg);
        border-radius: 0 0 12px 12px;
        padding: 10px 12px 12px;
        border: 1px solid var(--card-border);
        border-top: none;
        box-shadow: 0 -1px 0 var(--card-border);
        position: sticky;
        bottom: 0;
        z-index: 10;
      }
      .input-main {
        display: flex;
        align-items: stretch;
        gap: 10px;
      }
      .input-main textarea {
        min-height: 60px;
        max-height: 120px;
        flex: 1;
      }
      .input-actions {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 6px;
      }
      .input-actions button {
        white-space: nowrap;
        padding-inline: 24px;
      }
      .input-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-top: 6px;
        font-size: 12px;
      }
      .input-controls label {
        font-size: 12px;
        margin-bottom: 2px;
      }
    </style>
  </head>
  <body class="theme-light">
    <div id="app" class="app-container">
      <div class="header">
        <h1>
          {{ language === 'zh'
            ? '基于大语言模型的保险知识库问答系统'
            : 'Question Answering System Based on LLM' }}
        </h1>
        <div class="header-controls">
          <div>
            <label class="inline-label">
              {{ language === 'zh' ? '语言' : 'Language' }}
            </label>
            <select v-model="language">
              <option value="zh">中文</option>
              <option value="en">English</option>
            </select>
          </div>
          <div>
            <label class="inline-label">
              {{ language === 'zh' ? '主题' : 'Theme' }}
            </label>
            <select v-model="theme">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card chat-card" style="margin-bottom: 16px;">
        <div class="chat-window">
          <template v-if="turns.length">
            <div
              v-for="(turn, idx) in turns"
              :key="idx"
              class="turn-block"
            >
              <div class="msg-row user">
                <div class="msg-icon user">
                  {{ language === 'zh' ? '问' : 'Q' }}
                </div>
                <div class="msg-bubble user">
                  {{ turn.question }}
                </div>
              </div>
              <div v-if="turn.answer" class="msg-row assistant">
                <div class="msg-icon assistant">
                  {{ language === 'zh' ? '答' : 'A' }}
                </div>
                <div class="msg-bubble assistant">
                  {{ turn.answer }}
                </div>
              </div>
              <div v-if="turn.refs && turn.refs.length" class="kb-section">
                <button
                  type="button"
                  class="kb-toggle"
                  @click="turn.showRefs = !turn.showRefs"
                >
                  {{ language === 'zh' ? '知识库匹配结果（点击展开/收起）' : 'Knowledge base matches (click to expand/collapse)' }}
                  <span class="chevron" :class="{ open: turn.showRefs }">▼</span>
                </button>
                <div v-if="turn.showRefs" class="kb-panel">
                  <div
                    v-for="(ref, rIndex) in turn.refs"
                    :key="rIndex"
                    class="ref-item"
                  >
                    <div>
                      [{{ rIndex + 1 }}] {{ ref.text.slice(0, 200) }}{{ ref.text.length > 200 ? '...' : '' }}
                    </div>
                    <div class="ref-meta">
                      score={{ ref.score }}
                      <span v-if="ref.metadata && ref.metadata.source">
                        ｜ {{ language === 'zh' ? '来源' : 'Source' }}：{{ ref.metadata.source }}
                      </span>
                      <span v-if="ref.metadata && ref.metadata.page_number">
                        ｜ {{ language === 'zh' ? '页码' : 'Page' }}：{{ ref.metadata.page_number }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>
          <div v-else class="empty-hint">
            {{ language === 'zh'
              ? '还没有对话，先在下方输入你的问题开始吧。'
              : 'No messages yet. Type your question below to start.' }}
          </div>
        </div>
      </div>

      <div class="input-card">
        <div class="input-main">
          <textarea
            id="question"
            v-model="question"
            :placeholder="language === 'zh'
              ? '请输入你的保险相关问题，例如：意外医疗保险如何理赔？'
              : 'Please input your insurance question, e.g. How to claim accidental medical insurance?'
            "
          ></textarea>
          <div class="input-actions">
            <button :disabled="loading || !question.trim()" @click="ask">
              <span v-if="!loading">{{ language === 'zh' ? '发送问题' : 'Ask' }}</span>
              <span v-else>{{ language === 'zh' ? '正在检索与生成...' : 'Retrieving & generating...' }}</span>
            </button>
            <button
              class="ghost-button"
              type="button"
              @click="clearChat"
              :disabled="loading || !messages.length"
            >
              {{ language === 'zh' ? '清空对话' : 'Clear chat' }}
            </button>
          </div>
        </div>
        <div class="input-controls">
          <div>
            <label>
              {{ language === 'zh' ? '回答风格：' : 'Answer style:' }}
            </label>
            <select v-model="mode">
              <option value="expert">{{ language === 'zh' ? '专家' : 'Expert' }}</option>
              <option value="customer">{{ language === 'zh' ? '客服' : 'Customer service' }}</option>
              <option value="academic">{{ language === 'zh' ? '学术' : 'Academic' }}</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <div>
            <label>
              {{ language === 'zh' ? '参考片段数量 (top_k)：' : 'Number of reference chunks (top_k):' }}
            </label>
            <input type="number" v-model.number="top_k" min="1" max="10" />
          </div>
          <div class="status" :class="{ error: error }" style="margin-left:auto; margin-top:0;">
            <span v-if="error">{{ error }}</span>
            <span v-else-if="loading">
              {{ language === 'zh' ? '正在调用 RAG + LLM，请稍候...' : 'Calling RAG + LLM, please wait...' }}
            </span>
            <span v-else-if="messages.length">
              {{ language === 'zh' ? '继续提问以延续本次对话。' : 'Ask another question to continue this conversation.' }}
            </span>
            <span v-else>
              {{ language === 'zh' ? '输入问题后点击“发送问题”开始对话。' : 'Type a question and click "Ask" to start chatting.' }}
            </span>
          </div>
        </div>
      </div>

      <!-- 每轮问答的知识库匹配结果已折叠展示在上方对话中 -->
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            question: "",
            mode: "expert",
            top_k: 3,
            loading: false,
            refs: [],
            error: "",
            language: "zh",
            theme: "light",
            messages: [],
            turns: [],
          };
        },
        methods: {
          async ask() {
            this.error = "";
            this.refs = [];
            const q = this.question.trim();
            if (!q) return;

            const history = this.messages.map((m) => ({
              role: m.role,
              content: m.content,
            }));

            const pendingIndex = this.turns.length;
            this.turns.push({
              question: q,
              answer: "",
              refs: [],
              showRefs: false,
            });

            // 先把本轮用户消息加到 UI
            this.messages.push({ role: "user", content: q });
            this.question = "";

            this.loading = true;
            try {
              const resp = await fetch("/api/ask", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  question: q,
                  top_k: this.top_k,
                  mode: this.mode,
                  history,
                }),
              });

              if (!resp.ok) {
                const text = await resp.text();
                throw new Error(`HTTP ${resp.status}: ${text}`);
              }

              const data = await resp.json();
              this.refs = data.refs || [];
              if (data.answer) {
                this.messages.push({ role: "assistant", content: data.answer });
                const turn = this.turns[pendingIndex];
                if (turn) {
                  turn.answer = data.answer;
                  turn.refs = this.refs;
                }
              }
            } catch (err) {
              console.error(err);
              this.error =
                this.language === "zh"
                  ? "调用服务失败，请检查后端是否已启动 (uvicorn api_server:app)。"
                  : "Request failed. Please check that the backend (uvicorn api_server:app) is running.";
            } finally {
              this.loading = false;
            }
          },
          applyTheme() {
            const body = document.body;
            body.classList.remove("theme-dark", "theme-light");
            body.classList.add(this.theme === "dark" ? "theme-dark" : "theme-light");
          },
          clearChat() {
            this.messages = [];
            this.refs = [];
            this.error = "";
            this.question = "";
            this.turns = [];
          },
        },
        mounted() {
          this.applyTheme();
        },
        computed: {
          lastAnswer() {
            for (let i = this.messages.length - 1; i >= 0; i--) {
              const m = this.messages[i];
              if (m.role === "assistant") {
                return m.content;
              }
            }
            return "";
          },
        },
        watch: {
          theme() {
            this.applyTheme();
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
